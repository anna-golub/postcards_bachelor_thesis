# Поиск дубликатов в базе открыток

**Цель**: найти случаи дублирования открыток в базе.  
**Основная идея**: если два скана открыток - это одинаковые или очень похожие фотографии, то у них будут одинаковые или близкие хеши.

## Предварительное исследование

`pre_research`

В моем распоряжении была база открыток, где заранее было известно о случаях дублирования. Оно выражалось в следующем:

* на одном из сканов вокруг открытки есть поля, а на другом нет
* сканы повернуты друг относительно друга на 90 градусов
* сканы лицевой и оборотной стороны в одном из случаев идут в обратном порядке

Чтобы оценить эффективность метода, был проведен подсчет хешей для этих открыток. В каждой паре дубликатов Были посчитаны хеши лицевой и обратной стороны и найдена попарная разница. Для этого использовалась функция `dhash` из библиотеки `imagehash`. Как показывают [примеры](https://github.com/JohannesBuchner/imagehash#example-2-art-dataset) из [документации](https://github.com/JohannesBuchner/imagehash#imagehash), эта функция лучше всего выявляет отличия между фотографиями, похожими на живописные картины.  

Расчет показал, что разница (hamming distance) между разными сканами одной открытки может достигать 45. Конкретнее, значения распределились следующим образом:
* разница **меньше 15** - дублирование в 100% случаев
* разница от **15** до **45** - дублирование в некоторых случаях, но не во всех
* разница **больше 45** - прецедентов дублирования нет

На этом основании было предложено посчитать хеши всех сканов в базах <<Пишу тебе>> и попарные расстояния между ними. Случаи, где расстояние окажется меньше 15, стали бы кандидатами на дублирование.

## Расчет хешей
`hash_value_calculation` 

Для каждой открытки в трех базах <<Пишу тебе>> был посчитан хеш скана лицевой и обратной стороны. Результаты были сохранены в датафрейм `hash_database_full`:
* **base** - номер базы (1, 2, 3)
* **ID** - идентификатор открытки в базе
* **Pic_url_1** - ссылка на скан лицевой стороны
* **Pic_url_2** - ссылка на скан оборотной стороны
* **hash_1** - хеш лицевой стороны
* **hash_2** - хеш оборотной стороны

Первичный анализ показал, что среди открыток есть случаи полного совпадения хешей. Размер такого кластера - две или три открытки. Общее число кластеров 207, суммарно в них ходит 425 фотографий (отдельно учитывались лицевые и обратные стороны, то есть эти открытки составляют порядка **100** из **14 000** открыток в трех базах). 

## Поиск кластеров дублирования: матрица попарных расстояний
`doubles_search_distance_matrix`

Чтобы выявить дубликаты, сначала использовалась матрица попарных расстояний. Были посчитаны расстояния между всеми парами фотографий в базе. Результаты сохранены как матрица `hash_distances`, где на пересечении i-ой строки и j-ого столбца записано расстояние между сканами, индексы (!) которых в `hash_database_full` равны i, j. Перестановка i, j местами роли не играет.

Была сделана попытка обнаружить кластеры, в которых расстояния между всеми фотографиями малы, но не равны 0. Для этого был адаптирован алгоритм кластеризации K-means. В качестве узлов рассматривались фотографии, а мерой расстояния служили уже известные расстояния между хешами.

**Алгоритм**:
* задать число кластеров K
* случайным образом инициализировать центроиды K кластеров
* пока не будет превышено максимальное число итераций или кластеры не перестанут меняться:
    * распределить узлы по кластерам (узел относится к тому кластеру, чей центроид к нему ближайший)
    * обновить центроиды (центроидом становится узел, мода расстояний от которого до остальных узлов в кластере наименьшая)

Были отобраны узлы, которые хотя бы с одним другим узлом находятся на расстоянии от 0 до 10. Эти данные использовались для обучения модели. Было взято K = 3000 на 3347 узлов в модели, максимальное число итераций было 250.

Однако обнаружить новые кластеры этим методом не удалось. K-means находит почти только кластеры, где хеши полностью совпадают. Там, где в кластере максимальное расстояние между хешами больше 0, но меньше 10, реального дублирования не обнаружено (хеши близки, но это разные открытки).

Пары сканов, расстояние между которыми составляет от 1 до 5, были добавлены в таблицу для ручного отсмотра. 

## Поиск кластеров дублирования: ВК-дерево
`doubles_search_bk_tree`

Расчет матрицы попарных расстояний имеет высокую сложность по времени и памяти. Кроме того, такой подход плохо адаптируется к неизбежным расширениям базы. Более удобно для поиска дубликатов использовать ВК-дерево - метрическое дерево, в котором каждое k-ое поддерево содержит узлы на расстоянии k от корня поддерева. В реализации был использован код [pybktree](https://github.com/benhoyt/pybktree), адаптированный для совместимости с imagehash. 

Построение дерева и поиск в нем работают значительно быстрее, чем поиск с помощью матрицы попарных расстояний. Дерево не требуется хранить, поэтому такой подход также выигрывает по времени, и его легко применить повторно после добавления в базу новых открыток (см. `check_doubles_in_new_base`). 

Алгоритм:

1. Построить дерево.
2. Выполнить поиск в дереве для каждого скана. Гиперпараметр - пороговое расстояние между хешами, использовалось значение 3.
3. Обработать результаты: исключить повторы в таблице дубликатов, дополнить таблицу ссылками на изображения. 
4. Передать таблицу на ручную проверку ([инструкция](https://docs.google.com/document/d/1cFXD9vCAyLdxtV6FYkEH9nSCuaeGt-jun0flc1QO5r8/edit#)). Дубликатами считаются открытки, одинаковые с обеих сторон. 


## Результаты (промежуточные)
Ручной отсмотр возможных дубликатов (расстояние не более 5) показал, что **с точностью не менее 78%, если расстояние между хешами двух фотографий 2 или менее, они являются сканами одной открытки**.

* полное совпадение хешей: 425 сканов (пары и тройки дубликатов)
* расстояние 1: 19 из 21 пар - 90% дублирования
* расстояние 2: 21 из 27 пар - 78% дублирования
* расстояние 3: 16 из 54 пар - 30% дублирования

Таким образом, **пороговое значение 2** может использоваться **для проверки открытки на дублирование перед добавлением в базу**. Однако такая фильтрация не исключает возникновения дубликатов, поскольку расстояние между ними может достигать 45.
